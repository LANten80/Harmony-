/**
 * å·¥å•ç®¡ç†é¡µé¢ç»„ä»¶
 * æ˜¾ç¤ºå·¥å•åˆ—è¡¨å’Œè¿›åº¦ç®¡ç†
 * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œä¸æ˜¯ç‹¬ç«‹é¡µé¢ï¼Œä¸éœ€è¦ @Entry è£…é¥°å™¨
 */

import { TaskItemModel } from '../viewmodel/TaskItemModel';
import { DataModel } from '../viewmodel/DataModel';
import { TargetInformation } from './TargetInformation';
import { TargetList } from './TargetList';
import { AddTargetDialog } from './AddTargetDialog';
import { common } from '@kit.AbilityKit';

/**
 * getContext å‡½æ•°ç±»å‹å®šä¹‰
 */
type GetContextFunction = () => common.UIAbilityContext | undefined;

@Component
export struct TaskPage {
  // é¡µé¢çº§çŠ¶æ€
  @State targetData: TaskItemModel[] = [];
  @State totalTasksNumber: number = 0;
  @State completedTasksNumber: number = 0;
  @State overallProgress: number = 0;

  // å…¨å±€çŠ¶æ€æä¾›
  @Provide overAllProgressChanged: number = 0;

  // å¼¹çª—æ§åˆ¶å™¨ï¼ˆåœ¨ aboutToAppear ä¸­åˆå§‹åŒ–ï¼‰
  dialogController?: CustomDialogController;

  // æ•°æ®æ¨¡å‹å®ä¾‹
  private dataModel: DataModel = DataModel.getInstance();

  // åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨å£°æ˜å¼æ–¹å¼è·å–ï¼‰
  private context: common.UIAbilityContext | null = null;
  
  // æ ‡è®°æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡æ•°æ®
  private dataInitialized: boolean = false;

  /**
   * é¡µé¢å³å°†æ˜¾ç¤ºæ—¶è°ƒç”¨
   */
  async aboutToAppear(): Promise<void> {
    console.info('TaskPage.aboutToAppear: é¡µé¢åˆå§‹åŒ–å¼€å§‹');
    
    try {
      // åˆå§‹åŒ–å¼¹çª—æ§åˆ¶å™¨ï¼ˆå¿…é¡»åœ¨ aboutToAppear ä¸­åˆå§‹åŒ–ï¼Œé¿å…å¾ªç¯å¼•ç”¨ï¼‰
      this.dialogController = new CustomDialogController({
        builder: AddTargetDialog({
          controller: this.dialogController,
          onClickOk: (taskName: string) => {
            this.saveTask(taskName);
          }
        }),
        alignment: DialogAlignment.Bottom,
        customStyle: true,
        autoCancel: true
      });
      console.info('TaskPage.aboutToAppear: å¼¹çª—æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
    } catch (err) {
      console.error('TaskPage.aboutToAppear: å¼¹çª—æ§åˆ¶å™¨åˆå§‹åŒ–å¤±è´¥:', JSON.stringify(err));
    }

    // åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨å£°æ˜å¼æ–¹å¼ï¼‰
    this.initContext();
    
    // æ³¨å†Œæ•°æ®å˜æ›´ç›‘å¬å™¨
    this.dataModel.addChangeListener(() => {
      console.info('TaskPage: æ•°æ®å˜æ›´ç›‘å¬å™¨è§¦å‘ï¼Œåˆ·æ–°æ•°æ®');
      this.loadData();
      this.calculateStatistics();
    });
  }

  /**
   * åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨å£°æ˜å¼æ–¹å¼ï¼‰
   */
  private initContext(): void {
    try {
      // ä½¿ç”¨å£°æ˜å¼æ–¹å¼è·å–ä¸Šä¸‹æ–‡
      const contextGetter = getContext as GetContextFunction;
      const contextValue: common.UIAbilityContext | undefined = contextGetter();

      if (contextValue) {
        this.context = contextValue;
        this.dataModel.setContext(contextValue);
        console.info('TaskPage.initContext: è·å–ä¸Šä¸‹æ–‡æˆåŠŸ');
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™å¼ºåˆ¶é‡æ–°åŠ è½½ï¼ˆå³ä½¿å·²ç»åˆå§‹åŒ–è¿‡ï¼‰
        const currentData = this.dataModel.getData();
        console.error('ğŸ”µğŸ”µğŸ”µ TaskPage.initContext: å½“å‰æ•°æ®æ•°é‡: ' + String(currentData.length));
        console.error('ğŸ”µğŸ”µğŸ”µ TaskPage.initContext: dataInitialized=' + String(this.dataInitialized));
        if (currentData.length === 0) {
          console.error('âš ï¸âš ï¸âš ï¸ TaskPage.initContext: æ£€æµ‹åˆ°æ•°æ®ä¸ºç©ºï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½ï¼');
          this.dataModel.reloadDataFromStorage().then(() => {
            const reloadedData = this.dataModel.getData();
            console.error('âœ…âœ…âœ… TaskPage.initContext: é‡æ–°åŠ è½½å®Œæˆï¼Œå·¥å•æ•°: ' + String(reloadedData.length));
            console.error('âœ…âœ…âœ… TaskPage.initContext: é‡æ–°åŠ è½½çš„å·¥å•IDåˆ—è¡¨: ' + JSON.stringify(reloadedData.map(item => item.id)));
            this.loadData();
            this.calculateStatistics();
            this.dataInitialized = true;
          }).catch((err: Error) => {
            console.error('âŒâŒâŒ TaskPage.initContext: é‡æ–°åŠ è½½æ•°æ®å¤±è´¥: ' + JSON.stringify(err));
            this.loadData();
            this.calculateStatistics();
            this.dataInitialized = true;
          });
        } else if (!this.dataInitialized) {
          // åªåœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶ä»å­˜å‚¨åŠ è½½æ•°æ®
          this.dataModel.loadDataFromStorage().then(() => {
            this.loadData();
            this.calculateStatistics();
            this.dataInitialized = true;
          }).catch(() => {
            console.warn('TaskPage.initContext: ä»å­˜å‚¨åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            this.loadData();
            this.calculateStatistics();
            this.dataInitialized = true;
          });
        } else {
          // å·²ç»åˆå§‹åŒ–è¿‡ä¸”æ•°æ®ä¸ä¸ºç©ºï¼Œåªä½¿ç”¨å†…å­˜ä¸­çš„æ•°æ®
          this.loadData();
          this.calculateStatistics();
        }
      } else {
        console.warn('TaskPage.initContext: è·å–ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
        if (!this.dataInitialized) {
          this.loadData();
          this.calculateStatistics();
          this.dataInitialized = true;
        } else {
          this.loadData();
          this.calculateStatistics();
        }
      }
    } catch (err) {
      console.error('TaskPage.initContext: åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¤±è´¥:', JSON.stringify(err));
      if (!this.dataInitialized) {
        this.loadData();
        this.calculateStatistics();
        this.dataInitialized = true;
      } else {
        this.loadData();
        this.calculateStatistics();
      }
    }
  }

  /**
   * åŠ è½½æ•°æ®
   */
  loadData(): void {
    try {
      const data = this.dataModel.getData();
      console.info('TaskPage.loadData åŠ è½½æ•°æ®ï¼Œå·¥å•æ•°:', data.length);
      
      // æ ¡éªŒæ•°æ®æœ‰æ•ˆæ€§
      if (!data || !Array.isArray(data)) {
        console.warn('TaskPage.loadData: æ•°æ®æ— æ•ˆï¼Œä½¿ç”¨ç©ºæ•°ç»„');
        this.targetData = [];
        this.calculateStatistics();
        return;
      }

      // ç¡®ä¿æ•°æ®æ­£ç¡®æ›´æ–°ï¼Œä½¿ç”¨æ·±æ‹·è´è§¦å‘UIæ›´æ–°
      this.targetData = [...data.map(item => {
        try {
          // åˆ›å»ºæ–°å¯¹è±¡ï¼Œç¡®ä¿æ¯ä¸ªå±æ€§éƒ½è¢«æ­£ç¡®å¤åˆ¶
          const newItem = new TaskItemModel(item.taskName, item.description, item.progressValue, item.priority);
          newItem.id = item.id;
          newItem.status = item.status;
          newItem.createDate = item.createDate;
          newItem.updateDate = item.updateDate;
          newItem.dueDate = item.dueDate;
          newItem.assignee = item.assignee;
          newItem.category = item.category;
          newItem.tags = [...item.tags];
          return newItem;
        } catch (err) {
          console.error('TaskPage.loadData: åˆ›å»ºå·¥å•å¯¹è±¡å¤±è´¥:', JSON.stringify(err));
          return item;
        }
      })];
      
      this.calculateStatistics();
      console.info('TaskPage.loadData: æ•°æ®åŠ è½½å®Œæˆï¼Œå·¥å•æ•°:', this.targetData.length);
    } catch (err) {
      console.error('TaskPage.loadData: åŠ è½½æ•°æ®å¼‚å¸¸:', JSON.stringify(err));
      this.targetData = [];
      this.calculateStatistics();
    }
  }

  /**
   * è®¡ç®—ç»Ÿè®¡æ•°æ®
   */
  calculateStatistics(): void {
    try {
      const stats = this.dataModel.getStatistics();
      this.totalTasksNumber = stats.total;
      this.completedTasksNumber = stats.completed;
      this.overallProgress = stats.averageProgress;
      console.info('TaskPage.calculateStatistics: ç»Ÿè®¡è®¡ç®—å®Œæˆ', stats);
    } catch (err) {
      console.error('TaskPage.calculateStatistics: ç»Ÿè®¡è®¡ç®—å¼‚å¸¸:', JSON.stringify(err));
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  refreshData(): void {
    console.info('TaskPage.refreshData: åˆ·æ–°æ•°æ®');
    this.loadData();
  }

  /**
   * ä¿å­˜å·¥å•ï¼ˆå¼‚æ­¥ï¼Œé€šè¿‡åç«¯APIï¼‰
   */
  async saveTask(taskName: string): Promise<void> {
    console.info('TaskPage.saveTask: æ–¹æ³•è¢«è°ƒç”¨ï¼Œå·¥å•åç§°:', taskName);
    if (!taskName || taskName.trim().length === 0) {
      console.warn('TaskPage.saveTask: å·¥å•åç§°ä¸ºç©ºï¼Œå–æ¶ˆæ·»åŠ ');
      return;
    }

    console.info('TaskPage.saveTask: å¼€å§‹æ·»åŠ å·¥å•:', taskName, 'å½“å‰å·¥å•æ•°:', this.targetData.length);
    const success = await this.dataModel.addData(taskName);
    console.info('TaskPage.saveTask: addData è¿”å›ç»“æœ:', success);
    
    if (success) {
      console.info('TaskPage.saveTask: å·¥å•æ·»åŠ æˆåŠŸï¼Œå¼€å§‹åˆ·æ–°æ•°æ®');
      // ç«‹å³åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿UIæ›´æ–°
      this.loadData();
      this.calculateStatistics();
      this.overAllProgressChanged++;
      console.info('TaskPage.saveTask: æ•°æ®åˆ·æ–°å®Œæˆï¼Œå½“å‰å·¥å•æ•°:', this.targetData.length);
      console.info('TaskPage.saveTask: å½“å‰å·¥å•IDåˆ—è¡¨:', this.targetData.map(item => item.id));
    } else {
      console.warn('TaskPage.saveTask: å·¥å•æ·»åŠ å¤±è´¥');
    }
  }

  /**
   * æ‰“å¼€æ·»åŠ å·¥å•å¼¹çª—
   */
  openAddDialog(): void {
    console.info('TaskPage.openAddDialog: å‡†å¤‡æ‰“å¼€æ·»åŠ å¼¹çª—');
    if (this.dialogController) {
      console.info('TaskPage.openAddDialog: å¼¹çª—æ§åˆ¶å™¨å­˜åœ¨ï¼Œæ‰“å¼€å¼¹çª—');
      this.dialogController.open();
    } else {
      console.error('TaskPage.openAddDialog: å¼¹çª—æ§åˆ¶å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰“å¼€å¼¹çª—');
    }
  }

  /**
   * åˆ é™¤å·¥å•
   */
  async deleteTasks(taskIds: string[]): Promise<void> {
    console.info('TaskPage.deleteTasks: å¼€å§‹åˆ é™¤å·¥å•, taskIds:', taskIds);
    try {
      const deletedCount = await this.dataModel.deleteTasks(taskIds);
      if (deletedCount > 0) {
        // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°æ•°æ®
        this.loadData();
        this.calculateStatistics();
        this.overAllProgressChanged++;
        console.info('TaskPage.deleteTasks: åˆ é™¤æˆåŠŸï¼Œåˆ é™¤äº† ' + deletedCount + ' ä¸ªå·¥å•ï¼Œå½“å‰å·¥å•æ•°:', this.targetData.length);
      } else {
        // åˆ é™¤å¤±è´¥ï¼Œä¸åˆ·æ–°æ•°æ®
        console.warn('TaskPage.deleteTasks: åˆ é™¤å¤±è´¥ï¼Œæ²¡æœ‰å·¥å•è¢«åˆ é™¤');
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·æç¤ºï¼Œæ¯”å¦‚æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      }
    } catch (err) {
      console.error('TaskPage.deleteTasks åˆ é™¤æ“ä½œå¼‚å¸¸:', JSON.stringify(err));
      // åˆ é™¤å¤±è´¥æ—¶ï¼Œä¸åˆ·æ–°æ•°æ®ï¼Œä¿æŒUIçŠ¶æ€
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·æç¤ºï¼Œæ¯”å¦‚æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      // ArkTSåªå…è®¸throw Errorå¯¹è±¡
      if (err instanceof Error) {
        throw err;
      } else {
        throw new Error(`åˆ é™¤å·¥å•å¤±è´¥: ${JSON.stringify(err)}`);
      }
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('å·¥å•ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#182431')

        Blank()

        Image($r('app.media.foreground'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.refreshData();
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // æ•´ä½“è¿›åº¦å±•ç¤ºåŒº
      TargetInformation({
        totalTasksNumber: this.totalTasksNumber,
        completedTasksNumber: this.completedTasksNumber,
        overallProgress: this.overallProgress
      })

      // å·¥å•åˆ—è¡¨åŒº
      TargetList({
        targetData: $targetData,
        onAddClick: () => {
          this.openAddDialog();
        },
        onProgressChange: () => {
          console.info('TaskPage.onProgressChange: è¿›åº¦å˜åŒ–å›è°ƒè¢«è§¦å‘');
          // å¼ºåˆ¶åˆ·æ–°æ•°æ®
          this.loadData();
          this.calculateStatistics();
          this.overAllProgressChanged++;
          console.info('TaskPage.onProgressChange: æ•°æ®åˆ·æ–°å®Œæˆ, å½“å‰å·¥å•æ•°:', this.targetData.length);
        },
        onDeleteTasks: async (taskIds: string[]) => {
          console.info('TaskPage onDeleteTasks å›è°ƒè¢«è§¦å‘:', taskIds);
          await this.deleteTasks(taskIds);
          // åˆ é™¤åå¼ºåˆ¶åˆ·æ–°åˆ—è¡¨ï¼ˆdeleteTaskså†…éƒ¨å·²åˆ·æ–°ï¼Œè¿™é‡Œç¡®ä¿å†æ¬¡åˆ·æ–°ï¼‰
          this.loadData();
        }
      })

      // åº•éƒ¨æ“ä½œæç¤º
      Text('æç¤ºï¼šç‚¹å‡»å·¥å•é¡¹å±•å¼€è¿›åº¦è®¾ç½®é¢æ¿')
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 16, bottom: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#F5F5F5')
    .onAppear(() => {
      // å¦‚æœä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–ï¼Œå†æ¬¡å°è¯•åˆå§‹åŒ–
      if (!this.context) {
        this.initContext();
      } else {
        // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºä¸”DataModelæœªåŠ è½½è¿‡ï¼Œåˆ™å¼ºåˆ¶é‡æ–°åŠ è½½
        const currentData = this.dataModel.getData();
        console.error('ğŸ”µğŸ”µğŸ”µ TaskPage.onAppear: å½“å‰æ•°æ®æ•°é‡: ' + String(currentData.length));
        if (currentData.length === 0) {
          // æ•°æ®ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½
          // é€šè¿‡æ£€æŸ¥DataModelçš„dataLoadedFromApiæ ‡å¿—æ¥åˆ¤æ–­
          // å¦‚æœdataLoadedFromApiä¸ºfalseï¼Œè¯´æ˜æ•°æ®è¢«æ¸…é™¤äº†ï¼Œéœ€è¦é‡æ–°åŠ è½½
          console.error('âš ï¸âš ï¸âš ï¸ TaskPage.onAppear: æ£€æµ‹åˆ°æ•°æ®ä¸ºç©ºï¼Œå°è¯•é‡æ–°åŠ è½½ï¼');
          this.dataModel.reloadDataFromStorage().then(() => {
            const reloadedData = this.dataModel.getData();
            console.error('âœ…âœ…âœ… TaskPage.onAppear: é‡æ–°åŠ è½½å®Œæˆï¼Œå·¥å•æ•°: ' + String(reloadedData.length));
            console.error('âœ…âœ…âœ… TaskPage.onAppear: é‡æ–°åŠ è½½çš„å·¥å•IDåˆ—è¡¨: ' + JSON.stringify(reloadedData.map(item => item.id)));
            this.loadData();
            this.calculateStatistics();
          }).catch((err: Error) => {
            console.error('âŒâŒâŒ TaskPage.onAppear: é‡æ–°åŠ è½½æ•°æ®å¤±è´¥: ' + JSON.stringify(err));
            this.loadData();
            this.calculateStatistics();
          });
        } else {
          // ä¸Šä¸‹æ–‡å·²å­˜åœ¨ï¼Œåªåˆ·æ–°å†…å­˜ä¸­çš„æ•°æ®ï¼ˆä¸é‡æ–°ä»å­˜å‚¨åŠ è½½ï¼Œé¿å…è¦†ç›–åˆ é™¤æ“ä½œï¼‰
          this.loadData();
          this.calculateStatistics();
        }
      }
    })
  }
}



