# 前端后端连接问题诊断指南

## 🔍 问题现象
- 工单提交时，Java后端运行页没有运行
- 前端发送请求，但后端没有收到（后端日志没有显示）

## 🎯 可能的原因

### 1. BASE_URL配置错误（最常见）

**当前配置：** `entry/src/main/ets/common/constants/CommonConstant.ets`
```typescript
export const BASE_URL = 'http://10.0.2.2:8080/api';
```

**问题分析：**
- `10.0.2.2` 是HarmonyOS模拟器访问宿主机的特殊地址
- 如果应用运行在真机上，需要使用电脑的局域网IP
- 如果后端运行在其他机器上，需要使用对应的IP地址

### 2. 网络权限问题
- 已检查：`module.json5` 中已配置 `ohos.permission.INTERNET` 权限 ✅

### 3. 后端服务未启动或端口错误
- 后端应该运行在 `http://localhost:8080/api`
- 检查后端服务是否真的在运行

### 4. 防火墙或网络限制
- 真机环境可能被防火墙阻止
- 模拟器环境应该没问题

---

## 🛠️ 诊断步骤

### 步骤1：确认应用运行环境

**问题：** 你的HarmonyOS应用运行在哪里？
- [ ] HarmonyOS模拟器
- [ ] 真机设备

### 步骤2：检查BASE_URL配置

**如果运行在模拟器：**
```typescript
export const BASE_URL = 'http://10.0.2.2:8080/api';
```
✅ 这个配置是正确的

**如果运行在真机：**
需要改成电脑的局域网IP，例如：
```typescript
export const BASE_URL = 'http://192.168.1.100:8080/api';
```

**如何获取电脑的局域网IP：**

**Windows:**
1. 打开命令提示符（CMD）
2. 输入：`ipconfig`
3. 查找 "IPv4 地址"，例如：`192.168.1.100`

**Linux/Mac:**
1. 打开终端
2. 输入：`ifconfig` 或 `ip addr`
3. 查找局域网IP地址

### 步骤3：测试网络连接

**在HarmonyOS设备/模拟器上测试：**

**方法1：使用浏览器（如果有）**
在设备浏览器中访问：
```
http://10.0.2.2:8080/api/user/user_1234567890_abc12345
```
或（真机环境）
```
http://你的电脑IP:8080/api/user/user_1234567890_abc12345
```

**方法2：查看应用日志**
运行应用，尝试创建工单，查看DevEco Studio的Log窗口：

**成功连接的日志示例：**
```
HttpUtil.request: 准备发送请求 - POST http://10.0.2.2:8080/api/task/create
HttpUtil.request: BASE_URL = http://10.0.2.2:8080/api, 完整URL = http://10.0.2.2:8080/api/task/create
HttpUtil.request: 开始发送HTTP请求，超时时间: 10000ms
HttpUtil.request: HTTP请求已发送，等待响应...
HttpUtil.request: 响应状态码 200, 数据: {...}
```

**连接失败的日志示例：**
```
HttpUtil.request: 准备发送请求 - POST http://10.0.2.2:8080/api/task/create
HttpUtil.request: 请求失败 {"code":"ECONNREFUSED",...}
HttpUtil.request: 连接被拒绝 - 后端服务可能未启动或地址错误
```

### 步骤4：确认后端服务状态

**检查后端是否运行：**
1. 在浏览器中访问：`http://localhost:8080/api`
2. 查看后端控制台是否有启动日志
3. 确认后端运行在8080端口

**测试后端接口：**
使用Postman或浏览器测试：
```
GET http://localhost:8080/api/user/user_1234567890_abc12345
```
应该返回JSON响应

---

## 🔧 修复方案

### 方案1：修复BASE_URL配置（真机环境）

如果应用运行在真机上，修改 `entry/src/main/ets/common/constants/CommonConstant.ets`：

```typescript
// 修改前
export const BASE_URL = 'http://10.0.2.2:8080/api';

// 修改后（使用你的电脑IP）
export const BASE_URL = 'http://192.168.1.100:8080/api';  // 替换为你的实际IP
```

### 方案2：检查后端服务

1. **确认后端服务已启动**
   ```bash
   cd Java
   mvn spring-boot:run
   ```

2. **确认后端运行在正确端口**
   检查 `Java/src/main/resources/application.yml`:
   ```yaml
   server:
     port: 8080
     servlet:
       context-path: /api
   ```

3. **测试后端接口**
   在浏览器访问：`http://localhost:8080/api`

### 方案3：检查防火墙（真机环境）

**Windows防火墙：**
1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 添加入站规则，允许8080端口

**或者临时关闭防火墙测试：**
1. 控制面板 → Windows Defender 防火墙
2. 关闭防火墙（仅用于测试）

### 方案4：使用网络诊断工具

我已经增强了日志输出，现在会显示：
- BASE_URL配置
- 完整请求URL
- 请求头信息
- 详细的错误信息

运行应用后，查看日志即可知道具体问题。

---

## 📋 快速检查清单

- [ ] **确认应用运行环境**：模拟器 / 真机
- [ ] **检查BASE_URL配置**：是否正确对应运行环境
- [ ] **确认后端服务运行**：浏览器可以访问 `http://localhost:8080/api`
- [ ] **测试网络连接**：在设备上测试后端地址
- [ ] **查看应用日志**：确认请求是否发送
- [ ] **检查防火墙**：真机环境需要允许8080端口

---

## 🎯 下一步操作

1. **告诉我你的运行环境**：模拟器还是真机？

2. **如果是真机，告诉我你的电脑IP**：
   - Windows: 运行 `ipconfig` 查看IPv4地址
   - 我会帮你修改BASE_URL配置

3. **运行应用并查看日志**：
   - 尝试创建工单
   - 复制Log窗口中的关键日志
   - 特别是包含 "HttpUtil.request" 的日志

4. **测试后端连接**：
   - 在浏览器访问后端地址
   - 确认后端服务正常运行

---

## 💡 常见错误及解决方案

### 错误1：ECONNREFUSED（连接被拒绝）
**原因：** 后端服务未启动或地址错误
**解决：** 启动后端服务，确认端口和地址正确

### 错误2：timeout（超时）
**原因：** 网络不通或后端响应慢
**解决：** 检查网络连接，确认BASE_URL正确

### 错误3：Network error（网络错误）
**原因：** 网络权限或防火墙问题
**解决：** 检查网络权限配置，真机环境检查防火墙

### 错误4：后端没有收到请求
**原因：** BASE_URL配置错误，请求发送到了错误的地址
**解决：** 检查BASE_URL配置，确认与运行环境匹配



